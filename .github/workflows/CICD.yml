name: deploy node app

on:
    push:
        branches: [main]

jobs:
    build-and-publish:
        name: Build and Publish Docker Image
        runs-on: ubuntu-latest
        steps:
            - name: checkout source
              uses: actions/checkout@v3
            - name: Build the docker image
              run: docker build . --file Dockerfile --tag uyadav585/nodejs-app:${{ github.sha }}

            - name: Publish to Registry
              uses: elgohr/Publish-Docker-Github-Action@v4
              with:
                name: uyadav585/nodejs-app
                username: ${{ secrets.DOCKERHUB_USERNAME }}
                password: ${{ secrets.DOCKERHUB_TOKEN }}
                tags: "latest,${{ github.sha }}"


    deploy:
        needs: build-and-publish
        runs-on: self-hosted
        steps:
          - name: Ensure Docker socket permissions
            run:  sudo chmod 666 /var/run/docker.sock
          - name: remove running container
            run:  docker rm -f nodejs-app-container
          - name: clean up waste docker images
            run : docker rmi -f $(docker images -q)
          - name: pull image from dockerhub
            run:  docker pull uyadav585/nodejs-app:${{ github.sha }}
          - name: run docker container
            run:  docker run -d -p 4000:4000 --name nodejs-app-container -e MONGO_PASSWORD='${{ secrets.MONGO_PASSWORD }}' uyadav585/nodejs-app:${{ github.sha }}


# lets see what happens on final try